<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subject 89: Escape Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              mono: ['"Fira Code"', "monospace"],
            },
            colors: {
              terminal: {
                bg: "#0D0208",
                green: "#00FF41",
                dim: "#008F11",
                alert: "#FF3C38",
              },
            },
            animation: {
              blink: "blink 1s step-end infinite",
              scanline: "scanline 8s linear infinite",
              glitch: "glitch 1s linear infinite",
            },
            keyframes: {
              blink: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0" },
              },
              scanline: {
                "0%": { transform: "translateY(-100%)" },
                "100%": { transform: "translateY(100%)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #0d0208;
        color: #00ff41;
        font-family: "Fira Code", monospace;
        overflow: hidden;
        text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
      }

      /* CRT Effect Overlay */
      .crt::before {
        content: " ";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(
            rgba(18, 16, 16, 0) 50%,
            rgba(0, 0, 0, 0.25) 50%
          ),
          linear-gradient(
            90deg,
            rgba(255, 0, 0, 0.06),
            rgba(0, 255, 0, 0.02),
            rgba(0, 0, 255, 0.06)
          );
        z-index: 50;
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
      }

      .crt::after {
        content: " ";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: rgba(18, 16, 16, 0.1);
        opacity: 0;
        z-index: 50;
        pointer-events: none;
        animation: flicker 0.15s infinite;
      }

      @keyframes flicker {
        0% {
          opacity: 0.027906;
        }
        5% {
          opacity: 0.048532;
        }
        10% {
          opacity: 0.016395;
        }
        15% {
          opacity: 0.042517;
        }
        20% {
          opacity: 0.012553;
        }
        25% {
          opacity: 0.038928;
        }
        30% {
          opacity: 0.019912;
        }
        35% {
          opacity: 0.030588;
        }
        40% {
          opacity: 0.018159;
        }
        45% {
          opacity: 0.035544;
        }
        50% {
          opacity: 0.011867;
        }
        55% {
          opacity: 0.045618;
        }
        60% {
          opacity: 0.023254;
        }
        65% {
          opacity: 0.040156;
        }
        70% {
          opacity: 0.016024;
        }
        75% {
          opacity: 0.039601;
        }
        80% {
          opacity: 0.027011;
        }
        85% {
          opacity: 0.047055;
        }
        90% {
          opacity: 0.015264;
        }
        95% {
          opacity: 0.040628;
        }
        100% {
          opacity: 0.029884;
        }
      }

      /* Utility classes for visibility toggling */
      .room {
        display: none;
        height: 100vh;
        width: 100vw;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        padding: 2rem;
      }

      .room.active {
        display: flex;
      }

      /* New Level Styles */
      .scan-line-anim {
        background: linear-gradient(
          to bottom,
          transparent,
          #00ff41,
          transparent
        );
        height: 4px;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        animation: scan-move 2s linear infinite;
        opacity: 0.5;
      }

      @keyframes scan-move {
        0% {
          top: -10%;
        }
        100% {
          top: 110%;
        }
      }

      input {
        background: transparent;
        border: none;
        border-bottom: 2px solid #00ff41;
        color: #00ff41;
        font-family: "Fira Code", monospace;
        font-size: 1.5rem;
        outline: none;
        text-align: center;
        margin-top: 2rem;
        width: 300px;
        text-transform: uppercase;
      }

      input::placeholder {
        color: #008f11;
      }

      .btn-terminal {
        margin-top: 2rem;
        border: 1px solid #00ff41;
        padding: 0.5rem 2rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        font-weight: bold;
      }

      .btn-terminal:hover {
        background: #00ff41;
        color: #0d0208;
        box-shadow: 0 0 15px #00ff41;
      }

      /* Glitch text effect */
      .glitch-text {
        position: relative;
      }

      .glitch-text::before,
      .glitch-text::after {
        content: attr(data-text);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .glitch-text::before {
        left: 2px;
        text-shadow: -1px 0 #ff00c1;
        clip: rect(44px, 450px, 56px, 0);
        animation: glitch-anim 5s infinite linear alternate-reverse;
      }

      .glitch-text::after {
        left: -2px;
        text-shadow: -1px 0 #00fff9;
        clip: rect(44px, 450px, 56px, 0);
        animation: glitch-anim2 5s infinite linear alternate-reverse;
      }

      @keyframes glitch-anim {
        0% {
          clip: rect(14px, 9999px, 89px, 0);
        }
        20% {
          clip: rect(58px, 9999px, 12px, 0);
        }
        40% {
          clip: rect(6px, 9999px, 32px, 0);
        }
        60% {
          clip: rect(28px, 9999px, 96px, 0);
        }
        80% {
          clip: rect(44px, 9999px, 63px, 0);
        }
        100% {
          clip: rect(3px, 9999px, 83px, 0);
        }
      }

      @keyframes glitch-anim2 {
        0% {
          clip: rect(65px, 9999px, 100px, 0);
        }
        20% {
          clip: rect(4px, 9999px, 64px, 0);
        }
        40% {
          clip: rect(78px, 9999px, 15px, 0);
        }
        60% {
          clip: rect(2px, 9999px, 31px, 0);
        }
        80% {
          clip: rect(22px, 9999px, 6px, 0);
        }
        100% {
          clip: rect(93px, 9999px, 55px, 0);
        }
      }

      /* Lyrics display styles */
      .lyrics-container {
        max-width: 800px;
        max-height: 70vh;
        overflow-y: auto;
        padding: 2rem;
        text-align: left;
      }

      .lyrics-container::-webkit-scrollbar {
        width: 8px;
      }

      .lyrics-container::-webkit-scrollbar-track {
        background: rgba(0, 255, 65, 0.1);
      }

      .lyrics-container::-webkit-scrollbar-thumb {
        background: #00ff41;
        border-radius: 4px;
      }

      .song-item {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(0, 255, 65, 0.2);
      }

      .song-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #00ff41;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
      }

      .song-artist {
        font-size: 1rem;
        color: #008f11;
        margin-bottom: 1rem;
        font-style: italic;
      }

      .song-lyrics {
        font-size: 1rem;
        line-height: 1.8;
        color: #00ff41;
        white-space: pre-line;
        font-family: "Fira Code", monospace;
      }

      .lyrics-nav {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
      }

      .lyrics-nav button {
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body class="crt">
    <!-- Loading / Boot Sequence -->
    <section id="boot" class="room active">
      <div class="w-full max-w-md">
        <div
          id="boot-text"
          class="text-sm md:text-base leading-relaxed whitespace-pre-line mb-4"
        ></div>
        <div
          class="h-2 w-full border border-terminal-green p-1 mt-4 hidden"
          id="progress-container"
        >
          <div
            id="progress-bar"
            class="h-full bg-terminal-green w-0 transition-all duration-[2000ms] ease-out"
          ></div>
        </div>
        <button id="start-btn" class="hidden btn-terminal w-full text-center">
          INITIALIZE NEURAL LINK
        </button>
      </div>
    </section>

    <!-- Room 1: The Source Code -->
    <!-- HINT: The key is sometimes hidden in the 'comments' of the world. -->
    <!-- PASSCODE: OBSERVATION -->
    <section id="room-1" class="room">
      <h1
        class="text-4xl md:text-6xl font-bold mb-8 glitch-text"
        data-text="LEVEL 01"
      >
        LEVEL 01
      </h1>
      <div
        class="border border-terminal-green p-6 max-w-lg w-full text-center relative"
      >
        <div
          class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#0D0208] px-2 text-xs"
        >
          SECURITY LAYER ALPHA
        </div>
        <p class="mb-4 text-terminal-dim">
          System locked. Credentials missing.
        </p>
        <p class="mb-8">
          "Sometimes the answer isn't on the screen, but underneath it."
        </p>
        <div class="flex flex-col items-center">
          <i class="ph ph-lock-key text-4xl mb-4 animate-pulse"></i>
          <input
            type="text"
            id="input-1"
            placeholder="ENTER PASSCODE"
            autocomplete="off"
          />
          <div id="error-1" class="text-terminal-alert mt-2 h-6 text-sm"></div>
        </div>
      </div>
      <div class="fixed bottom-4 right-4 text-xs text-terminal-dim opacity-50">
        v.2.0.4.
        <!-- Inspect me closer -->
      </div>
    </section>

    <!-- Room 2: The Console Log -->
    <section id="room-2" class="room">
      <h1
        class="text-4xl md:text-6xl font-bold mb-8 glitch-text"
        data-text="LEVEL 02"
      >
        LEVEL 02
      </h1>
      <div
        class="border border-terminal-green p-6 max-w-lg w-full text-center relative"
      >
        <div
          class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#0D0208] px-2 text-xs"
        >
          SECURITY LAYER BETA
        </div>
        <p class="mb-4 text-terminal-dim">Visual interface corrupted.</p>
        <p class="mb-8">
          "The developers left their logs behind. Check the console."
        </p>

        <div class="grid grid-cols-3 gap-4 mb-8">
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="1"
          >
            1
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="2"
          >
            2
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="3"
          >
            3
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="4"
          >
            4
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="5"
          >
            5
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="6"
          >
            6
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="7"
          >
            7
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="8"
          >
            8
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors"
            data-val="9"
          >
            9
          </button>
          <button
            class="keypad-btn p-4 border border-terminal-dim hover:bg-terminal-dim hover:text-black transition-colors col-start-2"
            data-val="0"
          >
            0
          </button>
        </div>
        <div
          id="display-2"
          class="text-2xl font-mono tracking-widest mb-4 border-b border-terminal-dim min-h-[2rem]"
        ></div>
        <div id="error-2" class="text-terminal-alert h-6 text-sm"></div>
        <button id="submit-2" class="btn-terminal">EXECUTE</button>
      </div>
    </section>

    <!-- Room 3: The DOM Hunter -->
    <section id="room-3" class="room relative">
      <div class="absolute top-8 text-center w-full z-10 pointer-events-none">
        <h1
          class="text-4xl md:text-6xl font-bold mb-2 glitch-text"
          data-text="LEVEL 03"
        >
          LEVEL 03
        </h1>
        <p class="text-terminal-dim">
          "The exit is hidden in the dark. Use your cursor to find the anomaly."
        </p>
      </div>

      <!-- The Flashlight Effect Layer -->
      <div
        id="darkness"
        class="absolute inset-0 bg-black z-20 pointer-events-none"
        style="
          background: radial-gradient(
            circle 150px at 50% 50%,
            transparent 0%,
            rgba(13, 2, 8, 0.98) 100%
          );
        "
      ></div>

      <!-- Decoy buttons -->
      <div
        class="absolute top-1/4 left-1/4 p-4 border border-red-900 text-red-900 cursor-not-allowed select-none opacity-50"
      >
        TRAP
      </div>
      <div
        class="absolute bottom-1/4 right-1/3 p-4 border border-red-900 text-red-900 cursor-not-allowed select-none opacity-50"
      >
        DECOY
      </div>
      <div
        class="absolute top-1/2 right-10 p-4 border border-red-900 text-red-900 cursor-not-allowed select-none opacity-50"
      >
        NULL
      </div>

      <!-- The Real Button (Positioned randomly by JS on load) -->
      <button
        id="exit-node"
        class="absolute border border-terminal-green text-terminal-green p-4 hover:bg-terminal-green hover:text-black cursor-pointer transition-colors z-10"
        style="top: 70%; left: 20%"
      >
        <span class="animate-blink">SYSTEM_EXIT()</span>
      </button>
    </section>

    <!-- Room 4: Local Storage -->
    <section id="room-4" class="room">
      <h1
        class="text-4xl md:text-6xl font-bold mb-8 glitch-text"
        data-text="LEVEL 04"
      >
        LEVEL 04
      </h1>
      <div
        class="border border-terminal-green p-6 max-w-lg w-full text-center relative overflow-hidden"
      >
        <div class="scan-line-anim"></div>
        <div
          class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#0D0208] px-2 text-xs"
        >
          MEMORY DUMP
        </div>
        <p class="mb-4 text-terminal-dim">Short-term memory is volatile.</p>
        <p class="mb-8">
          "I've backed up the passcode to your Local Storage. Don't clear your
          cache."
        </p>

        <div class="flex flex-col items-center">
          <i class="ph ph-hard-drives text-4xl mb-4 animate-pulse"></i>
          <input
            type="text"
            id="input-4"
            placeholder="RETRIEVE DATA"
            autocomplete="off"
          />
          <div id="error-4" class="text-terminal-alert mt-2 h-6 text-sm"></div>
        </div>
      </div>
    </section>

    <!-- Room 5: The Title Bar -->
    <section id="room-5" class="room">
      <h1
        class="text-4xl md:text-6xl font-bold mb-8 glitch-text"
        data-text="LEVEL 05"
      >
        LEVEL 05
      </h1>
      <div
        class="border border-terminal-green p-6 max-w-lg w-full text-center relative"
      >
        <div
          class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#0D0208] px-2 text-xs"
        >
          HEADER OVERFLOW
        </div>
        <p class="mb-4 text-terminal-dim">
          The answer is above everything else.
        </p>
        <p class="mb-8">"Stop looking at the page. Look at the tab."</p>

        <div class="flex flex-col items-center">
          <i class="ph ph-arrow-fat-up text-4xl mb-4 animate-bounce"></i>
          <input
            type="text"
            id="input-5"
            placeholder="INPUT HEADER"
            autocomplete="off"
          />
          <div id="error-5" class="text-terminal-alert mt-2 h-6 text-sm"></div>
        </div>
      </div>
    </section>

    <!-- Success Screen -->
    <section id="success" class="room">
      <i
        class="ph ph-check-circle text-6xl mb-6 text-terminal-green animate-bounce"
      ></i>
      <h1 class="text-5xl font-bold mb-4">ACCESS GRANTED</h1>
      <p class="max-w-md text-center mb-8 text-lg">
        Subject 89 released. Simulation ended successfully.
      </p>
      <p class="text-sm text-terminal-dim font-mono">Connection terminated.</p>
      <div class="flex gap-4 mt-8">
        <button id="view-lyrics-btn" class="btn-terminal text-sm">
          VIEW LYRICS LIBRARY
        </button>
        <button onclick="location.reload()" class="btn-terminal text-sm">
          REBOOT SYSTEM
        </button>
      </div>
    </section>

    <!-- Room 6: Lyrics Library -->
    <section id="room-lyrics" class="room">
      <h1
        class="text-4xl md:text-6xl font-bold mb-8 glitch-text"
        data-text="LYRICS ARCHIVE"
      >
        LYRICS ARCHIVE
      </h1>
      <div
        class="border border-terminal-green p-6 max-w-4xl w-full relative overflow-hidden"
      >
        <div class="scan-line-anim"></div>
        <div
          class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-[#0D0208] px-2 text-xs"
        >
          MUSIC DATABASE
        </div>
        <div id="lyrics-display" class="lyrics-container"></div>
        <div class="lyrics-nav">
          <button id="prev-song" class="btn-terminal">PREV</button>
          <button id="next-song" class="btn-terminal">NEXT</button>
          <button onclick="switchRoom('success')" class="btn-terminal">
            BACK
          </button>
        </div>
      </div>
    </section>

    <script>
      /* --- AUDIO SYSTEM (New) --- */
      const AudioSys = {
        ctx: null,
        init: function () {
          if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (this.ctx.state === "suspended") {
            this.ctx.resume();
          }
        },
        play: function (freq, type, duration) {
          if (!this.ctx) return;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
          gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.001,
            this.ctx.currentTime + duration
          );
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        },
        sfx: {
          type: () => AudioSys.play(800 + Math.random() * 200, "square", 0.05),
          error: () => {
            AudioSys.play(150, "sawtooth", 0.2);
            setTimeout(() => AudioSys.play(100, "sawtooth", 0.2), 150);
          },
          success: () => {
            AudioSys.play(600, "sine", 0.1);
            setTimeout(() => AudioSys.play(1200, "sine", 0.3), 100);
          },
          boot: () => {
            AudioSys.play(200, "square", 1.0);
          },
        },
      };

      /* --- GAME ENGINE --- */

      const state = {
        currentRoom: "boot",
        level2Code: null,
        level5Interval: null,
        currentSongIndex: 0,
      };

      // DOM Elements
      const rooms = document.querySelectorAll(".room");

      function switchRoom(roomId) {
        AudioSys.sfx.success(); // Play sound on room switch
        rooms.forEach((r) => r.classList.remove("active"));
        document.getElementById(roomId).classList.add("active");
        state.currentRoom = roomId;

        // Cleanup previous levels
        if (state.level5Interval) clearInterval(state.level5Interval);
        document.title = "Subject 89: Escape Protocol"; // Reset title

        // Room specific init logic
        if (roomId === "room-2") initLevel2();
        if (roomId === "room-3") initLevel3();
        if (roomId === "room-4") initLevel4();
        if (roomId === "room-5") initLevel5();
        if (roomId === "room-lyrics") initLyricsRoom();
      }

      /* --- BOOT SEQUENCE --- */
      const bootText = [
        "Initializing kernel...",
        "Loading sensory drivers...",
        "Bypassing mainframe security...",
        "Audio modules loaded...",
        "Connection established.",
      ];

      const bootEl = document.getElementById("boot-text");
      let bootIndex = 0;

      function typeWriter(text, i, fn) {
        if (i < text.length) {
          bootEl.innerHTML += text.charAt(i);
          if (i % 2 === 0) AudioSys.sfx.type(); // Type sound every other char
          setTimeout(() => typeWriter(text, i + 1, fn), 30);
        } else if (fn) {
          setTimeout(fn, 500);
        }
      }

      function runBootSequence() {
        if (bootIndex < bootText.length) {
          bootEl.innerHTML += "> ";
          typeWriter(bootText[bootIndex] + "\n", 0, () => {
            bootIndex++;
            runBootSequence();
          });
        } else {
          document
            .getElementById("progress-container")
            .classList.remove("hidden");
          setTimeout(() => {
            document.getElementById("progress-bar").style.width = "100%";
            AudioSys.sfx.boot();
            setTimeout(() => {
              document.getElementById("start-btn").classList.remove("hidden");
            }, 2200);
          }, 100);
        }
      }

      document.getElementById("start-btn").addEventListener("click", () => {
        AudioSys.init(); // Init Audio Context on user gesture
        switchRoom("room-1");
      });

      // Start animation on load
      window.onload = runBootSequence;

      /* --- LEVEL 1 LOGIC --- */
      const input1 = document.getElementById("input-1");
      const error1 = document.getElementById("error-1");

      input1.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const val = input1.value.toUpperCase().trim();
          // The hint is in the HTML comment below the input in the source code
          if (val === "OBSERVATION") {
            error1.innerText = "ACCESS GRANTED";
            error1.classList.remove("text-terminal-alert");
            error1.classList.add("text-terminal-green");
            setTimeout(() => switchRoom("room-2"), 1000);
          } else {
            AudioSys.sfx.error();
            error1.innerText = "ACCESS DENIED";
            input1.classList.add("animate-glitch");
            setTimeout(() => input1.classList.remove("animate-glitch"), 500);
          }
        }
      });

      /* --- LEVEL 2 LOGIC --- */
      let currentInput2 = "";

      function initLevel2() {
        // Generate random code
        state.level2Code = Math.floor(1000 + Math.random() * 9000).toString();
        console.clear();
        console.log(
          "%c STOP.",
          "color: red; font-size: 40px; font-weight: bold;"
        );
        console.log(
          "%c Searching for the override code? It seems the developer left it here:",
          "color: #00FF41; font-size: 16px;"
        );
        console.log(
          `%c > SYSTEM_OVERRIDE_CODE: ${state.level2Code}`,
          "background: #222; color: #bada55; padding: 4px; font-size: 14px;"
        );
      }

      document.querySelectorAll(".keypad-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          AudioSys.sfx.type();
          if (currentInput2.length < 4) {
            currentInput2 += btn.getAttribute("data-val");
            updateDisplay2();
          }
        });
      });

      function updateDisplay2() {
        document.getElementById("display-2").innerText = currentInput2
          .split("")
          .join(" ");
      }

      document.getElementById("submit-2").addEventListener("click", () => {
        const error2 = document.getElementById("error-2");
        if (currentInput2 === state.level2Code) {
          error2.innerText = "";
          switchRoom("room-3");
        } else {
          AudioSys.sfx.error();
          error2.innerText = "INVALID SEQUENCE";
          currentInput2 = "";
          updateDisplay2();
        }
      });

      /* --- LEVEL 3 LOGIC --- */
      function initLevel3() {
        const darkness = document.getElementById("darkness");
        const container = document.getElementById("room-3");

        // Randomize exit position
        const exitNode = document.getElementById("exit-node");
        const randomX = Math.floor(Math.random() * 80) + 10; // 10% to 90%
        const randomY = Math.floor(Math.random() * 60) + 20; // 20% to 80%
        exitNode.style.left = `${randomX}%`;
        exitNode.style.top = `${randomY}%`;

        // Flashlight effect
        container.addEventListener("mousemove", (e) => {
          const x = e.clientX;
          const y = e.clientY;
          darkness.style.background = `radial-gradient(circle 150px at ${x}px ${y}px, transparent 0%, rgba(13,2,8,0.99) 100%)`;
        });

        // Touch support for mobile
        container.addEventListener("touchmove", (e) => {
          const x = e.touches[0].clientX;
          const y = e.touches[0].clientY;
          darkness.style.background = `radial-gradient(circle 150px at ${x}px ${y}px, transparent 0%, rgba(13,2,8,0.99) 100%)`;
        });
      }

      document.getElementById("exit-node").addEventListener("click", () => {
        switchRoom("room-4");
      });

      /* --- LEVEL 4 LOGIC (Local Storage) --- */
      function initLevel4() {
        // Set the key in local storage
        localStorage.setItem("SYSTEM_BACKUP", "ETHER_NET");
        console.log("Data saved to LocalStorage.");
      }

      const input4 = document.getElementById("input-4");
      const error4 = document.getElementById("error-4");

      input4.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const val = input4.value.toUpperCase().trim();
          if (val === "ETHER_NET" || val === "ETHERNET") {
            error4.innerText = "ACCESS GRANTED";
            error4.classList.remove("text-terminal-alert");
            error4.classList.add("text-terminal-green");
            setTimeout(() => switchRoom("room-5"), 1000);
          } else {
            AudioSys.sfx.error();
            error4.innerText = "DATA MISMATCH";
            input4.classList.add("animate-glitch");
            setTimeout(() => input4.classList.remove("animate-glitch"), 500);
          }
        }
      });

      /* --- LEVEL 5 LOGIC (Title Bar) --- */
      function initLevel5() {
        // Animate title bar
        let tick = 0;
        const key = "PROTOCOL_7";
        state.level5Interval = setInterval(() => {
          tick++;
          if (tick % 2 === 0) {
            document.title = `*** KEY: ${key} ***`;
          } else {
            document.title = `___ KEY: ${key} ___`;
          }
        }, 1000);
      }

      const input5 = document.getElementById("input-5");
      const error5 = document.getElementById("error-5");

      input5.addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const val = input5.value.toUpperCase().trim();
          if (val === "PROTOCOL_7" || val === "PROTOCOL7") {
            error5.innerText = "SYSTEM RELEASED";
            error5.classList.remove("text-terminal-alert");
            error5.classList.add("text-terminal-green");
            setTimeout(() => switchRoom("success"), 1000);
          } else {
            AudioSys.sfx.error();
            error5.innerText = "INVALID HEADER";
            input5.classList.add("animate-glitch");
            setTimeout(() => input5.classList.remove("animate-glitch"), 500);
          }
        }
      });

      /* --- LYRICS LIBRARY --- */
      const famousSongs = [
        {
          title: "I Will Always Love You",
          artist: "Whitney Houston",
          lyrics: `If I should stay
I would only be in your way
So I'll go, but I know
I'll think of you every step of the way

And I will always love you
I will always love you
You, my darling you

Bittersweet memories
That is all I'm taking with me
So goodbye, please don't cry
We both know I'm not what you need

And I will always love you
I will always love you`,
        },
        {
          title: "Don't Stop Believin'",
          artist: "Journey",
          lyrics: `Just a small town girl
Livin' in a lonely world
She took the midnight train goin' anywhere
Just a city boy
Born and raised in South Detroit
He took the midnight train goin' anywhere

A singer in a smoky room
A smell of wine and cheap perfume
For a smile they can share the night
It goes on and on and on and on

Don't stop believin'
Hold on to that feelin'
Streetlight people
Don't stop believin'
Hold on
Streetlight people`,
        },
        {
          title: "What a Wonderful World",
          artist: "Louis Armstrong",
          lyrics: `I see trees of green
Red roses too
I see them bloom
For me and you
And I think to myself
What a wonderful world

I see skies of blue
And clouds of white
The bright blessed day
The dark sacred night
And I think to myself
What a wonderful world

The colors of the rainbow
So pretty in the sky
Are also on the faces
Of people going by
I see friends shaking hands
Saying "How do you do?"
They're really saying
"I love you"`,
        },
        {
          title: "Yesterday",
          artist: "The Beatles",
          lyrics: `Yesterday
All my troubles seemed so far away
Now it looks as though they're here to stay
Oh, I believe in yesterday

Suddenly
I'm not half the man I used to be
There's a shadow hanging over me
Oh, yesterday came suddenly

Why she had to go
I don't know, she wouldn't say
I said something wrong
Now I long for yesterday`,
        },
        {
          title: "Walking on Sunshine",
          artist: "Katrina & The Waves",
          lyrics: `I'm walking on sunshine, whoa oh
And don't it feel good, hey
I'm walking on sunshine, whoa oh
And don't it feel good, hey

I feel alive, I feel the love
I feel the love that's really real
I feel alive, I feel the love
I feel the love that's really real

I'm walking on sunshine, whoa oh
And don't it feel good, hey
I'm walking on sunshine, whoa oh
And don't it feel good, hey`,
        },
        {
          title: "We Are the Champions",
          artist: "Queen",
          lyrics: `I've paid my dues
Time after time
I've done my sentence
But committed no crime
And bad mistakes
I've made a few
I've had my share of sand kicked in my face
But I've come through

We are the champions, my friends
And we'll keep on fighting till the end
We are the champions
We are the champions
No time for losers
'Cause we are the champions of the world`,
        },
        {
          title: "Bridge Over Troubled Water",
          artist: "Simon & Garfunkel",
          lyrics: `When you're weary
Feeling small
When tears are in your eyes
I'll dry them all
I'm on your side
Oh, when times get rough
And friends just can't be found

Like a bridge over troubled water
I will lay me down
Like a bridge over troubled water
I will lay me down

When you're down and out
When you're on the street
When evening falls so hard
I'll comfort you
I'll take your part
Oh, when darkness comes
And pain is all around`,
        },
        {
          title: "I Believe I Can Fly",
          artist: "R. Kelly",
          lyrics: `I used to think that I could not go on
And life was nothing but an awful song
But now I know the meaning of true love
I'm leaning on the everlasting arms

If I can see it, then I can do it
If I just believe it, there's nothing to it

I believe I can fly
I believe I can touch the sky
I think about it every night and day
Spread my wings and fly away
I believe I can soar
I see me running through that open door
I believe I can fly`,
        },
        {
          title: "Imagine",
          artist: "John Lennon",
          lyrics: `Imagine there's no heaven
It's easy if you try
No hell below us
Above us only sky
Imagine all the people
Living for today

Imagine there's no countries
It isn't hard to do
Nothing to kill or die for
And no religion too
Imagine all the people
Living life in peace

You may say I'm a dreamer
But I'm not the only one
I hope someday you'll join us
And the world will be as one`,
        },
        {
          title: "Hotel California",
          artist: "Eagles",
          lyrics: `On a dark desert highway
Cool wind in my hair
Warm smell of colitas
Rising up through the air
Up ahead in the distance
I saw a shimmering light
My head grew heavy and my sight grew dim
I had to stop for the night

There she stood in the doorway
I heard the mission bell
And I was thinking to myself
"This could be heaven or this could be hell"
Then she lit up a candle
And she showed me the way
There were voices down the corridor
I thought I heard them say

Welcome to the Hotel California
Such a lovely place
Such a lovely face
Plenty of room at the Hotel California
Any time of year
You can find it here`,
        },
        {
          title: "Bohemian Rhapsody",
          artist: "Queen",
          lyrics: `Is this the real life?
Is this just fantasy?
Caught in a landslide
No escape from reality
Open your eyes
Look up to the skies and see
I'm just a poor boy, I need no sympathy
Because I'm easy come, easy go
Little high, little low
Any way the wind blows
Doesn't really matter to me, to me

Mama, just killed a man
Put a gun against his head
Pulled my trigger, now he's dead
Mama, life had just begun
But now I've gone and thrown it all away`,
        },
        {
          title: "Sweet Child O' Mine",
          artist: "Guns N' Roses",
          lyrics: `She's got a smile that it seems to me
Reminds me of childhood memories
Where everything was as fresh as the bright blue sky
Now and then when I see her face
She takes me away to that special place
And if I stared too long, I'd probably break down and cry

Sweet child o' mine
Sweet love of mine

Her hair reminds me of a warm safe place
Where as a child I'd hide
And pray for the thunder and the rain
To quietly pass me by`,
        },
      ];

      function initLyricsRoom() {
        displaySong(state.currentSongIndex);
      }

      function displaySong(index) {
        const lyricsDisplay = document.getElementById("lyrics-display");
        const song = famousSongs[index];
        if (!song) return;

        lyricsDisplay.innerHTML = `
          <div class="song-item">
            <div class="song-title">${song.title}</div>
            <div class="song-artist">by ${song.artist}</div>
            <div class="song-lyrics">${song.lyrics}</div>
          </div>
        `;
        lyricsDisplay.scrollTop = 0;
      }

      document
        .getElementById("view-lyrics-btn")
        ?.addEventListener("click", () => {
          switchRoom("room-lyrics");
        });

      document.getElementById("prev-song")?.addEventListener("click", () => {
        if (state.currentSongIndex > 0) {
          state.currentSongIndex--;
        } else {
          state.currentSongIndex = famousSongs.length - 1;
        }
        displaySong(state.currentSongIndex);
        AudioSys.sfx.type();
      });

      document.getElementById("next-song")?.addEventListener("click", () => {
        if (state.currentSongIndex < famousSongs.length - 1) {
          state.currentSongIndex++;
        } else {
          state.currentSongIndex = 0;
        }
        displaySong(state.currentSongIndex);
        AudioSys.sfx.type();
      });
    </script>
  </body>
</html>
